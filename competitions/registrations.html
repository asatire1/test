<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Registrations - UberPadel</title>
    <meta name="description" content="Manage player registrations for your competition.">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/uberpadel-icon.svg">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #f97316;
            --primary-dark: #ea580c;
            --secondary: #0ea5e9;
            --secondary-dark: #0284c7;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text: #1f2937;
            --text-light: #6b7280;
            --bg: #ffffff;
            --bg-light: #f9fafb;
            --bg-dark: #f3f4f6;
            --border: #e5e7eb;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: var(--text);
            background: var(--bg-light);
            min-height: 100vh;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
            color: white;
            padding: 1rem;
        }
        .header-content {
            max-width: 1000px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .logo-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            color: white;
        }
        .logo-icon { width: 36px; height: 36px; }
        .logo-text { font-size: 1.25rem; font-weight: 700; }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }
        .btn-ghost { background: rgba(255,255,255,0.1); color: white; }
        .btn-ghost:hover { background: rgba(255,255,255,0.2); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--border); color: var(--text); }
        .btn-outline:hover { border-color: var(--text-light); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-warning { background: var(--warning); color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.8rem; }
        .btn-icon { padding: 0.5rem; min-width: 36px; }
        
        /* Main */
        .main { max-width: 1000px; margin: 0 auto; padding: 1.5rem 1rem 3rem; }
        
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-light);
            text-decoration: none;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
        }
        .back-link:hover { color: var(--secondary); }
        
        /* Page Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .page-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.25rem; }
        .page-subtitle { color: var(--text-light); font-size: 0.9rem; }
        
        /* Stats Row */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .stat-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
        }
        .stat-value { font-size: 1.5rem; font-weight: 700; }
        .stat-value.confirmed { color: var(--success); }
        .stat-value.pending { color: var(--warning); }
        .stat-value.waitlist { color: var(--secondary); }
        .stat-value.rejected { color: var(--danger); }
        .stat-label { font-size: 0.8rem; color: var(--text-light); }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.25rem;
            background: var(--bg-dark);
            padding: 0.25rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            overflow-x: auto;
        }
        .tab {
            padding: 0.625rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-light);
            background: transparent;
            border: none;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }
        .tab:hover { color: var(--text); }
        .tab.active { background: white; color: var(--text); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .tab-count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 20px;
            background: var(--bg-dark);
            border-radius: 10px;
            font-size: 0.75rem;
            margin-left: 0.375rem;
            padding: 0 0.375rem;
        }
        .tab.active .tab-count { background: var(--secondary); color: white; }
        .tab-count.pending-badge { background: var(--warning); color: white; }
        
        /* Card */
        .card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }
        .card-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-title { font-weight: 600; }
        
        /* Table */
        .table-container { overflow-x: auto; }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 0.875rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        th {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-light);
            background: var(--bg-light);
        }
        tr:last-child td { border-bottom: none; }
        tr:hover { background: var(--bg-light); }
        
        .player-cell {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .player-avatar {
            width: 36px;
            height: 36px;
            background: var(--bg-dark);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-light);
        }
        .player-name { font-weight: 500; }
        .player-email { font-size: 0.8rem; color: var(--text-light); }
        
        .level-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            background: var(--bg-dark);
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.625rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .status-confirmed { background: #dcfce7; color: #15803d; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-waitlist { background: #dbeafe; color: #1d4ed8; }
        .status-rejected { background: #fee2e2; color: #dc2626; }
        .status-cancelled { background: #f3f4f6; color: #6b7280; }
        
        .action-cell {
            display: flex;
            gap: 0.5rem;
        }
        
        .date-cell {
            font-size: 0.85rem;
            color: var(--text-light);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
        }
        .empty-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }
        .empty-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; }
        .empty-text { color: var(--text-light); }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-light);
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--secondary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Error State */
        .error-state {
            text-align: center;
            padding: 4rem 2rem;
        }
        .error-icon { font-size: 4rem; margin-bottom: 1rem; opacity: 0.5; }
        .error-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; }
        .error-text { color: var(--text-light); margin-bottom: 1.5rem; }
        
        /* Bulk Actions */
        .bulk-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            padding: 0.75rem 1rem;
            background: var(--bg-light);
            border-bottom: 1px solid var(--border);
        }
        .bulk-count {
            font-size: 0.875rem;
            color: var(--text-light);
            margin-right: auto;
        }
        
        .checkbox-cell { width: 40px; }
        .checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        /* Add Player */
        .add-player-form {
            padding: 1rem;
            background: var(--bg-light);
            border-top: 1px solid var(--border);
        }
        .add-form-row {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        .add-form-row input {
            flex: 1;
            min-width: 150px;
            padding: 0.625rem 0.875rem;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
        }
        .add-form-row input:focus {
            outline: none;
            border-color: var(--secondary);
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        
        .modal {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
            transform: scale(0.9);
            transition: transform 0.2s;
        }
        .modal-overlay.show .modal { transform: scale(1); }
        
        .modal-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title { font-size: 1.125rem; font-weight: 600; }
        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: var(--bg-light);
            cursor: pointer;
            font-size: 1.25rem;
        }
        .modal-body { padding: 1.25rem; }
        .modal-footer {
            padding: 1.25rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            background: var(--text);
            color: white;
            padding: 0.875rem 1.25rem;
            border-radius: 8px;
            font-size: 0.9rem;
            z-index: 1001;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.error { background: var(--danger); }
        .toast.success { background: var(--success); }
        
        @media (max-width: 768px) {
            th, td { padding: 0.75rem 0.5rem; font-size: 0.85rem; }
            .player-avatar { width: 32px; height: 32px; font-size: 0.75rem; }
            .action-cell { flex-direction: column; gap: 0.25rem; }
            .action-cell .btn { width: 100%; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo-container">
                <img src="/uberpadel-icon.svg" alt="UberPadel" class="logo-icon">
                <span class="logo-text">UberPadel</span>
            </a>
            <a href="/competitions/my-competitions.html" class="btn btn-ghost">My Competitions</a>
        </div>
    </header>
    
    <main class="main">
        <a href="/competitions/my-competitions.html" class="back-link">‚Üê Back to My Competitions</a>
        
        <!-- Loading State -->
        <div id="loading">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading registrations...</p>
            </div>
        </div>
        
        <!-- Error State -->
        <div id="error-state" class="card" style="display: none;">
            <div class="error-state">
                <div class="error-icon">üòï</div>
                <h2 class="error-title">Competition Not Found</h2>
                <p class="error-text">This competition doesn't exist or you don't have permission to manage it.</p>
                <a href="/competitions/my-competitions.html" class="btn btn-primary">Back to My Competitions</a>
            </div>
        </div>
        
        <!-- Main Content -->
        <div id="main-content" style="display: none;">
            <div class="page-header">
                <div>
                    <h1 class="page-title" id="comp-name">Competition Name</h1>
                    <p class="page-subtitle">Manage player registrations</p>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <a href="#" id="view-comp-btn" class="btn btn-outline">View Page</a>
                    <a href="#" id="edit-comp-btn" class="btn btn-outline">Edit</a>
                </div>
            </div>
            
            <!-- Stats -->
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-value confirmed" id="stat-confirmed">0</div>
                    <div class="stat-label">Confirmed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value pending" id="stat-pending">0</div>
                    <div class="stat-label">Pending</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value waitlist" id="stat-waitlist">0</div>
                    <div class="stat-label">Waitlist</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-spots">0</div>
                    <div class="stat-label">Spots Left</div>
                </div>
            </div>
            
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" data-tab="all">All<span class="tab-count" id="count-all">0</span></button>
                <button class="tab" data-tab="confirmed">Confirmed<span class="tab-count" id="count-confirmed">0</span></button>
                <button class="tab" data-tab="pending">Pending<span class="tab-count" id="count-pending">0</span></button>
                <button class="tab" data-tab="waitlist">Waitlist<span class="tab-count" id="count-waitlist">0</span></button>
                <button class="tab" data-tab="rejected">Rejected<span class="tab-count" id="count-rejected">0</span></button>
            </div>
            
            <!-- Registrations Table -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Registrations</span>
                    <button class="btn btn-sm btn-primary" onclick="showAddPlayerModal()">+ Add Player</button>
                </div>
                
                <!-- Bulk Actions (shown when items selected) -->
                <div class="bulk-actions" id="bulk-actions" style="display: none;">
                    <span class="bulk-count"><span id="selected-count">0</span> selected</span>
                    <button class="btn btn-sm btn-success" onclick="bulkApprove()">‚úì Approve</button>
                    <button class="btn btn-sm btn-danger" onclick="bulkReject()">‚úó Reject</button>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th class="checkbox-cell">
                                    <input type="checkbox" class="checkbox" id="select-all" onchange="toggleSelectAll()">
                                </th>
                                <th>Player</th>
                                <th>Level</th>
                                <th>Status</th>
                                <th>Registered</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="registrations-body">
                        </tbody>
                    </table>
                </div>
                
                <!-- Empty State -->
                <div class="empty-state" id="empty-state" style="display: none;">
                    <div class="empty-icon">üìã</div>
                    <h3 class="empty-title">No registrations yet</h3>
                    <p class="empty-text">Share your competition link to start getting registrations!</p>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Add Player Modal -->
    <div class="modal-overlay" id="add-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add Player Manually</h3>
                <button class="modal-close" onclick="closeAddModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">
                        Player Name <span style="color: var(--danger);">*</span>
                    </label>
                    <input type="text" id="add-name" placeholder="Enter player name" style="width: 100%; padding: 0.75rem; border: 1.5px solid var(--border); border-radius: 8px;">
                </div>
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">
                        Email (optional)
                    </label>
                    <input type="email" id="add-email" placeholder="player@email.com" style="width: 100%; padding: 0.75rem; border: 1.5px solid var(--border); border-radius: 8px;">
                </div>
                <div class="form-group">
                    <label style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">
                        Skill Level
                    </label>
                    <select id="add-level" style="width: 100%; padding: 0.75rem; border: 1.5px solid var(--border); border-radius: 8px;">
                        <option value="">Not specified</option>
                        <option value="1.0">1.0 - Beginner</option>
                        <option value="1.5">1.5</option>
                        <option value="2.0">2.0</option>
                        <option value="2.5">2.5</option>
                        <option value="3.0">3.0 - Intermediate</option>
                        <option value="3.5">3.5</option>
                        <option value="4.0">4.0</option>
                        <option value="4.5">4.5</option>
                        <option value="5.0">5.0 - Advanced</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeAddModal()">Cancel</button>
                <button class="btn btn-primary" onclick="addPlayer()" id="add-btn">Add Player</button>
            </div>
        </div>
    </div>
    
    <!-- Confirm Modal -->
    <div class="modal-overlay" id="confirm-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="confirm-title">Confirm Action</h3>
                <button class="modal-close" onclick="closeConfirmModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p id="confirm-message">Are you sure?</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeConfirmModal()">Cancel</button>
                <button class="btn" id="confirm-btn" onclick="executeConfirm()">Confirm</button>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDHnMaQMwH9R3yEVQPV1M_RPWz9gF3IBJI",
            authDomain: "stretford-padel-tournament.firebaseapp.com",
            databaseURL: "https://stretford-padel-tournament-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "stretford-padel-tournament",
            storageBucket: "stretford-padel-tournament.appspot.com",
            messagingSenderId: "802492722498",
            appId: "1:802492722498:web:ea2c0cd65ea2c0f40df9ee"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        
        let currentUser = null;
        let compId = null;
        let competition = null;
        let registrations = [];
        let currentTab = 'all';
        let selectedIds = new Set();
        let confirmAction = null;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            compId = params.get('id');
            
            if (!compId) {
                showError();
                return;
            }
            
            setupTabs();
            
            auth.onAuthStateChanged(user => {
                currentUser = user;
                if (user) {
                    loadCompetition();
                } else {
                    window.location.href = `/login.html?redirect=/competitions/registrations.html?id=${compId}`;
                }
            });
        });
        
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentTab = tab.dataset.tab;
                    renderTable();
                });
            });
        }
        
        async function loadCompetition() {
            try {
                const snapshot = await database.ref(`competitions/${compId}`).once('value');
                competition = snapshot.val();
                
                if (!competition || competition.organizer?.userId !== currentUser.uid) {
                    showError();
                    return;
                }
                
                // Parse registrations
                registrations = [];
                if (competition.registrations) {
                    Object.entries(competition.registrations).forEach(([key, val]) => {
                        registrations.push({ id: key, ...val });
                    });
                }
                
                // Sort by registration date (newest first)
                registrations.sort((a, b) => new Date(b.registeredAt) - new Date(a.registeredAt));
                
                document.getElementById('comp-name').textContent = competition.name;
                document.getElementById('view-comp-btn').href = `/competitions/detail.html?id=${compId}`;
                document.getElementById('edit-comp-btn').href = `/competitions/edit.html?id=${compId}`;
                
                updateStats();
                updateCounts();
                renderTable();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                
                // Listen for real-time updates
                database.ref(`competitions/${compId}/registrations`).on('value', snapshot => {
                    registrations = [];
                    const data = snapshot.val();
                    if (data) {
                        Object.entries(data).forEach(([key, val]) => {
                            registrations.push({ id: key, ...val });
                        });
                    }
                    registrations.sort((a, b) => new Date(b.registeredAt) - new Date(a.registeredAt));
                    updateStats();
                    updateCounts();
                    renderTable();
                });
                
            } catch (e) {
                console.error('Error loading:', e);
                showError();
            }
        }
        
        function updateStats() {
            const confirmed = registrations.filter(r => r.status === 'confirmed').length;
            const pending = registrations.filter(r => r.status === 'pending').length;
            const waitlist = registrations.filter(r => r.status === 'waitlist').length;
            const max = competition.players?.max || 16;
            const spots = Math.max(0, max - confirmed);
            
            document.getElementById('stat-confirmed').textContent = confirmed;
            document.getElementById('stat-pending').textContent = pending;
            document.getElementById('stat-waitlist').textContent = waitlist;
            document.getElementById('stat-spots').textContent = spots;
        }
        
        function updateCounts() {
            const counts = {
                all: registrations.length,
                confirmed: registrations.filter(r => r.status === 'confirmed').length,
                pending: registrations.filter(r => r.status === 'pending').length,
                waitlist: registrations.filter(r => r.status === 'waitlist').length,
                rejected: registrations.filter(r => r.status === 'rejected').length
            };
            
            Object.keys(counts).forEach(key => {
                const el = document.getElementById(`count-${key}`);
                el.textContent = counts[key];
                if (key === 'pending' && counts[key] > 0) {
                    el.classList.add('pending-badge');
                } else {
                    el.classList.remove('pending-badge');
                }
            });
        }
        
        function renderTable() {
            const tbody = document.getElementById('registrations-body');
            const empty = document.getElementById('empty-state');
            
            let filtered = registrations;
            if (currentTab !== 'all') {
                filtered = registrations.filter(r => r.status === currentTab);
            }
            
            if (filtered.length === 0) {
                tbody.innerHTML = '';
                empty.style.display = 'block';
                document.querySelector('.table-container').style.display = 'none';
                return;
            }
            
            empty.style.display = 'none';
            document.querySelector('.table-container').style.display = 'block';
            
            tbody.innerHTML = filtered.map(reg => {
                const initial = (reg.name || 'U')[0].toUpperCase();
                const statusClass = `status-${reg.status || 'pending'}`;
                const statusText = {
                    'confirmed': 'Confirmed',
                    'pending': 'Pending',
                    'waitlist': 'Waitlist',
                    'rejected': 'Rejected',
                    'cancelled': 'Cancelled'
                }[reg.status] || reg.status;
                
                const date = reg.registeredAt ? new Date(reg.registeredAt) : null;
                const dateStr = date ? date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) : '-';
                const timeStr = date ? date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }) : '';
                
                let actions = '';
                if (reg.status === 'pending') {
                    actions = `
                        <button class="btn btn-sm btn-success" onclick="approveReg('${reg.id}')">‚úì Approve</button>
                        <button class="btn btn-sm btn-danger" onclick="rejectReg('${reg.id}')">‚úó Reject</button>
                    `;
                } else if (reg.status === 'confirmed') {
                    actions = `
                        <button class="btn btn-sm btn-outline" onclick="moveToWaitlist('${reg.id}')">‚Üí Waitlist</button>
                        <button class="btn btn-sm btn-danger" onclick="removeReg('${reg.id}')">Remove</button>
                    `;
                } else if (reg.status === 'waitlist') {
                    actions = `
                        <button class="btn btn-sm btn-success" onclick="promoteFromWaitlist('${reg.id}')">‚úì Confirm</button>
                        <button class="btn btn-sm btn-danger" onclick="removeReg('${reg.id}')">Remove</button>
                    `;
                } else if (reg.status === 'rejected') {
                    actions = `
                        <button class="btn btn-sm btn-success" onclick="approveReg('${reg.id}')">‚úì Approve</button>
                        <button class="btn btn-sm btn-outline" onclick="removeReg('${reg.id}')">Delete</button>
                    `;
                }
                
                return `
                    <tr data-id="${reg.id}">
                        <td class="checkbox-cell">
                            <input type="checkbox" class="checkbox row-checkbox" data-id="${reg.id}" onchange="toggleSelect('${reg.id}')" ${selectedIds.has(reg.id) ? 'checked' : ''}>
                        </td>
                        <td>
                            <div class="player-cell">
                                <div class="player-avatar">${initial}</div>
                                <div>
                                    <div class="player-name">${esc(reg.name)}</div>
                                    ${reg.email ? `<div class="player-email">${esc(reg.email)}</div>` : ''}
                                </div>
                            </div>
                        </td>
                        <td>
                            ${reg.level ? `<span class="level-badge">${reg.level}</span>` : '<span style="color: var(--text-light);">-</span>'}
                        </td>
                        <td>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </td>
                        <td class="date-cell">
                            ${dateStr}<br><span style="opacity: 0.7;">${timeStr}</span>
                        </td>
                        <td>
                            <div class="action-cell">${actions}</div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            updateBulkActions();
        }
        
        function esc(s) { return s ? s.replace(/</g, '&lt;').replace(/>/g, '&gt;') : ''; }
        
        function showError() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-state').style.display = 'block';
        }
        
        // Selection
        function toggleSelect(id) {
            if (selectedIds.has(id)) {
                selectedIds.delete(id);
            } else {
                selectedIds.add(id);
            }
            updateBulkActions();
        }
        
        function toggleSelectAll() {
            const selectAll = document.getElementById('select-all');
            const filtered = currentTab === 'all' ? registrations : registrations.filter(r => r.status === currentTab);
            
            if (selectAll.checked) {
                filtered.forEach(r => selectedIds.add(r.id));
            } else {
                selectedIds.clear();
            }
            
            document.querySelectorAll('.row-checkbox').forEach(cb => {
                cb.checked = selectAll.checked;
            });
            
            updateBulkActions();
        }
        
        function updateBulkActions() {
            const bulk = document.getElementById('bulk-actions');
            const count = document.getElementById('selected-count');
            
            if (selectedIds.size > 0) {
                bulk.style.display = 'flex';
                count.textContent = selectedIds.size;
            } else {
                bulk.style.display = 'none';
            }
        }
        
        // Actions
        async function approveReg(id) {
            await updateStatus(id, 'confirmed');
            await updatePlayerCount();
            showToast('Registration approved', 'success');
        }
        
        async function rejectReg(id) {
            await updateStatus(id, 'rejected');
            showToast('Registration rejected');
        }
        
        async function moveToWaitlist(id) {
            await updateStatus(id, 'waitlist');
            await updatePlayerCount();
            showToast('Moved to waitlist');
        }
        
        async function promoteFromWaitlist(id) {
            const confirmed = registrations.filter(r => r.status === 'confirmed').length;
            const max = competition.players?.max || 16;
            
            if (confirmed >= max) {
                showToast('Competition is full. Remove a player first.', 'error');
                return;
            }
            
            await updateStatus(id, 'confirmed');
            await updatePlayerCount();
            showToast('Player confirmed', 'success');
        }
        
        async function removeReg(id) {
            const reg = registrations.find(r => r.id === id);
            confirmAction = async () => {
                await database.ref(`competitions/${compId}/registrations/${id}`).remove();
                await updatePlayerCount();
                showToast('Registration removed');
            };
            
            document.getElementById('confirm-title').textContent = 'Remove Registration';
            document.getElementById('confirm-message').textContent = `Remove ${reg?.name || 'this player'} from the competition?`;
            document.getElementById('confirm-btn').className = 'btn btn-danger';
            document.getElementById('confirm-btn').textContent = 'Remove';
            document.getElementById('confirm-modal').classList.add('show');
        }
        
        async function updateStatus(id, status) {
            await database.ref(`competitions/${compId}/registrations/${id}/status`).set(status);
            await database.ref(`competitions/${compId}/registrations/${id}/updatedAt`).set(new Date().toISOString());
        }
        
        async function updatePlayerCount() {
            const confirmed = registrations.filter(r => r.status === 'confirmed').length;
            await database.ref(`competitions/${compId}/players/current`).set(confirmed);
        }
        
        // Bulk Actions
        async function bulkApprove() {
            const pending = [...selectedIds].filter(id => {
                const reg = registrations.find(r => r.id === id);
                return reg && (reg.status === 'pending' || reg.status === 'waitlist');
            });
            
            if (pending.length === 0) {
                showToast('No pending registrations selected', 'error');
                return;
            }
            
            const confirmed = registrations.filter(r => r.status === 'confirmed').length;
            const max = competition.players?.max || 16;
            const available = max - confirmed;
            
            if (pending.length > available) {
                showToast(`Only ${available} spots available. Select fewer players.`, 'error');
                return;
            }
            
            for (const id of pending) {
                await updateStatus(id, 'confirmed');
            }
            await updatePlayerCount();
            
            selectedIds.clear();
            document.getElementById('select-all').checked = false;
            showToast(`${pending.length} registrations approved`, 'success');
        }
        
        async function bulkReject() {
            const pending = [...selectedIds].filter(id => {
                const reg = registrations.find(r => r.id === id);
                return reg && reg.status === 'pending';
            });
            
            if (pending.length === 0) {
                showToast('No pending registrations selected', 'error');
                return;
            }
            
            for (const id of pending) {
                await updateStatus(id, 'rejected');
            }
            
            selectedIds.clear();
            document.getElementById('select-all').checked = false;
            showToast(`${pending.length} registrations rejected`);
        }
        
        // Add Player
        function showAddPlayerModal() {
            document.getElementById('add-name').value = '';
            document.getElementById('add-email').value = '';
            document.getElementById('add-level').value = '';
            document.getElementById('add-modal').classList.add('show');
        }
        
        function closeAddModal() {
            document.getElementById('add-modal').classList.remove('show');
        }
        
        async function addPlayer() {
            const name = document.getElementById('add-name').value.trim();
            const email = document.getElementById('add-email').value.trim();
            const level = document.getElementById('add-level').value;
            
            if (!name) {
                showToast('Please enter a player name', 'error');
                return;
            }
            
            const btn = document.getElementById('add-btn');
            btn.disabled = true;
            btn.textContent = 'Adding...';
            
            try {
                const confirmed = registrations.filter(r => r.status === 'confirmed').length;
                const max = competition.players?.max || 16;
                const status = confirmed >= max ? 'waitlist' : 'confirmed';
                
                const registration = {
                    name,
                    email: email || null,
                    level: level ? parseFloat(level) : null,
                    status,
                    registeredAt: new Date().toISOString(),
                    addedBy: 'organizer'
                };
                
                await database.ref(`competitions/${compId}/registrations`).push(registration);
                await updatePlayerCount();
                
                closeAddModal();
                showToast(`Player added${status === 'waitlist' ? ' to waitlist' : ''}`, 'success');
            } catch (e) {
                console.error('Error adding player:', e);
                showToast('Failed to add player', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Add Player';
            }
        }
        
        // Confirm Modal
        function closeConfirmModal() {
            document.getElementById('confirm-modal').classList.remove('show');
            confirmAction = null;
        }
        
        async function executeConfirm() {
            if (confirmAction) {
                await confirmAction();
            }
            closeConfirmModal();
        }
        
        function showToast(msg, type = '') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = 'toast show ' + type;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
